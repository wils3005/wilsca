/*! peerjs.min.js build:0.0.1, production. Copyright(c) 2013 Michelle Bu <michelle@michellebu.com> */(function(e){function o(){this._pieces=[],this._parts=[]}function u(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function a(){this.bufferBuilder=new o}function f(e){this._config=e.config||{iceServers:[{url:"stun:stun.l.google.com:19302"}]},this._peer=e.source||null,this._video=e.video,this._data=e.data!=undefined?e.data:!0,this._audio=e.audio,this._pc=null,this._id=null,this._dc=null,this._socket=new WebSocket(e.ws||"ws://localhost");var t=this;this._socket.onopen=function(){t.socketInit()},this._handlers={};if(i=="Firefox"&&!e.source){f.usedPorts||(f.usedPorts=[]),this.localPort=l();while(f.usedPorts.indexOf(this.localPort)!=-1)this.localPort=l();this.remotePort=l();while(this.remotePort==this.localPort||f.usedPorts.indexOf(this.localPort)!=-1)this.remotePort=l();f.usedPorts.push(this.remotePort),f.usedPorts.push(this.localPort)}}function l(){return Math.round(Math.random()*60535)+5e3}var t=null,n=null,r=null,i=null;navigator.mozGetUserMedia?(i="Firefox",t=mozRTCPeerConnection,n=navigator.mozGetUserMedia.bind(navigator),r=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t,e.play()}):navigator.webkitGetUserMedia&&(i="Webkit",t=webkitRTCPeerConnection,n=navigator.webkitGetUserMedia.bind(navigator),r=function(e,t){e.src=webkitURL.createObjectURL(t)}),e.RTCPeerConnection=t,e.getUserMedia=n,e.attachMediaStream=r,e.browserisms=i;var s={};s.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),s.useArrayBufferView=!s.useBlobBuilder&&function(){try{return(new Blob([new Uint8Array([])])).size===0}catch(e){return!0}}(),e.binaryFeatures=s,e.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,o.prototype.append=function(e){typeof e=="number"?this._pieces.push(e):(this._flush(),this._parts.push(e))},o.prototype._flush=function(){if(this._pieces.length>0){var e=new Uint8Array(this._pieces);s.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},o.prototype.getBuffer=function(){this._flush();if(s.useBlobBuilder){var e=new BlobBuilder;for(var t=0,n=this._parts.length;t<n;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},e.BinaryPack={unpack:function(e){var t=new u(e);return t.unpack()},pack:function(e){var t=new a,n=t.pack(e);return n}},u.prototype.unpack=function(){var e=this.unpack_uint8();if(e<128){var t=e;return t}if((e^224)<32){var n=(e^224)-32;return n}var r;if((r=e^160)<=15)return this.unpack_raw(r);if((r=e^176)<=15)return this.unpack_string(r);if((r=e^144)<=15)return this.unpack_array(r);if((r=e^128)<=15)return this.unpack_map(r);switch(e){case 192:return null;case 193:return undefined;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return undefined;case 213:return undefined;case 214:return undefined;case 215:return undefined;case 216:return r=this.unpack_uint16(),this.unpack_string(r);case 217:return r=this.unpack_uint32(),this.unpack_string(r);case 218:return r=this.unpack_uint16(),this.unpack_raw(r);case 219:return r=this.unpack_uint32(),this.unpack_raw(r);case 220:return r=this.unpack_uint16(),this.unpack_array(r);case 221:return r=this.unpack_uint32(),this.unpack_array(r);case 222:return r=this.unpack_uint16(),this.unpack_map(r);case 223:return r=this.unpack_uint32(),this.unpack_map(r)}},u.prototype.unpack_uint8=function(){var e=this.dataView[this.index]&255;return this.index++,e},u.prototype.unpack_uint16=function(){var e=this.read(2),t=(e[0]&255)*256+(e[1]&255);return this.index+=2,t},u.prototype.unpack_uint32=function(){var e=this.read(4),t=((e[0]*256+e[1])*256+e[2])*256+e[3];return this.index+=4,t},u.prototype.unpack_uint64=function(){var e=this.read(8),t=((((((e[0]*256+e[1])*256+e[2])*256+e[3])*256+e[4])*256+e[5])*256+e[6])*256+e[7];return this.index+=8,t},u.prototype.unpack_int8=function(){var e=this.unpack_uint8();return e<128?e:e-256},u.prototype.unpack_int16=function(){var e=this.unpack_uint16();return e<32768?e:e-65536},u.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},u.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},u.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},u.prototype.unpack_string=function(e){var t=this.read(e),n=0,r="",i,s;while(n<e)i=t[n],i<128?(r+=String.fromCharCode(i),n++):(i^192)<32?(s=(i^192)<<6|t[n+1]&63,r+=String.fromCharCode(s),n+=2):(s=(i&15)<<12|(t[n+1]&63)<<6|t[n+2]&63,r+=String.fromCharCode(s),n+=3);return this.index+=e,r},u.prototype.unpack_array=function(e){var t=new Array(e);for(var n=0;n<e;n++)t[n]=this.unpack();return t},u.prototype.unpack_map=function(e){var t={};for(var n=0;n<e;n++){var r=this.unpack(),i=this.unpack();t[r]=i}return t},u.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=e>>31,n=(e>>23&255)-127,r=e&8388607|8388608;return(t==0?1:-1)*r*Math.pow(2,n-23)},u.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=e>>31,r=(e>>20&2047)-1023,i=e&1048575|1048576,s=i*Math.pow(2,r-20)+t*Math.pow(2,r-52);return(n==0?1:-1)*s},u.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},a.prototype.pack=function(e){var t=typeof e;if(t=="string")this.pack_string(e);else if(t=="number")Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if(t=="boolean")e===!0?this.bufferBuilder.append(195):e===!1&&this.bufferBuilder.append(194);else if(t=="undefined")this.bufferBuilder.append(192);else{if(t!="object")throw new Error('Type "'+t+'" not yet supported');if(e===null)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)s.useArrayBufferView?this.pack_bin(new Uint8Array(e)):this.pack_bin(e);else if("BYTES_PER_ELEMENT"in e)s.useArrayBufferView?this.pack_bin(e):this.pack_bin(e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if(typeof e.toBinaryPack!="function")throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}return this.bufferBuilder.getBuffer()},a.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},a.prototype.pack_string=function(e){var t=e.length;if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(t)}this.bufferBuilder.append(e)},a.prototype.pack_array=function(e){var t=e.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(t<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;n<t;n++)this.pack(e[n])},a.prototype.pack_integer=function(e){if(-32<=e&&e<=127)this.bufferBuilder.append(e&255);else if(0<=e&&e<=255)this.bufferBuilder.append(204),this.pack_uint8(e);else if(-128<=e&&e<=127)this.bufferBuilder.append(208),this.pack_int8(e);else if(0<=e&&e<=65535)this.bufferBuilder.append(205),this.pack_uint16(e);else if(-32768<=e&&e<=32767)this.bufferBuilder.append(209),this.pack_int16(e);else if(0<=e&&e<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(e);else if(-2147483648<=e&&e<=2147483647)this.bufferBuilder.append(210),this.pack_int32(e);else if(-0x8000000000000000<=e&&e<=0x8000000000000000)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(0<=e&&e<=0x10000000000000000))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},a.prototype.pack_double=function(e){var t=0;e<0&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),r=e/Math.pow(2,n)-1,i=Math.floor(r*Math.pow(2,52)),s=Math.pow(2,32),o=t<<31|n+1023<<20|i/s&1048575,u=i%s;this.bufferBuilder.append(203),this.pack_int32(o),this.pack_int32(u)},a.prototype.pack_object=function(e){var t=Object.keys(e),n=t.length;if(n<=15)this.pack_uint8(128+n);else if(n<=65535)this.bufferBuilder.append(222),this.pack_uint16(n);else{if(!(n<=4294967295))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(n)}for(var r in e)e.hasOwnProperty(r)&&(this.pack(r),this.pack(e[r]))},a.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},a.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(e&255)},a.prototype.pack_uint32=function(e){var t=e&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)},a.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((n&4278190080)>>>24),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)},a.prototype.pack_int8=function(e){this.bufferBuilder.append(e&255)},a.prototype.pack_int16=function(e){this.bufferBuilder.append((e&65280)>>8),this.bufferBuilder.append(e&255)},a.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)},a.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((n&4278190080)>>>24),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)},f.prototype.socketInit=function(){var e=this;this._peer?(this._socket.send(JSON.stringify({type:"SINK",source:this._peer,isms:i})),this._socket.onmessage=function(t){var n=JSON.parse(t.data);switch(n.type){case"SINK-ID":e._id=n.id,!e._handlers.ready||e._handlers.ready(e._id),e.startPeerConnection();break;case"OFFER":var r=n.sdp;try{r=new RTCSessionDescription(n.sdp)}catch(s){console.log("Firefox")}e._pc.setRemoteDescription(r,function(){console.log("setRemoteDescription: offer"),e.handleStream(!1,function(){e.maybeBrowserisms(!1)})},function(e){console.log("failed to setRemoteDescription with offer, ",e)});break;case"CANDIDATE":console.log(n.candidate);var o=new RTCIceCandidate(n.candidate);e._pc.addIceCandidate(o);break;case"PORT":if(i&&i=="Firefox"){f.usedPorts||(f.usedPorts=[]),f.usedPorts.push(n.local),f.usedPorts.push(n.remote),e._pc.connectDataConnection(n.local,n.remote);break};case"DEFAULT":console.log("SINK: unrecognized message ",n.type)}}):(this._socket.send(JSON.stringify({type:"SOURCE",isms:i})),this._socket.onmessage=function(t){var n=JSON.parse(t.data);switch(n.type){case"SOURCE-ID":e._id=n.id,!e._handlers.ready||e._handlers.ready(e._id);break;case"SINK-CONNECTED":e._peer=n.sink,e.startPeerConnection(),e.handleStream(!0,function(){e.maybeBrowserisms(!0)});break;case"ANSWER":var r=n.sdp;try{r=new RTCSessionDescription(n.sdp)}catch(s){console.log("Firefox")}e._pc.setRemoteDescription(r,function(){console.log("setRemoteDescription: answer"),i=="Firefox"&&(e._pc.connectDataConnection(e.localPort,e.remotePort),e._socket.send(JSON.stringify({type:"PORT",dst:e._peer,remote:e.localPort,local:e.remotePort}))),console.log("ORIGINATOR: PeerConnection success")},function(e){console.log("failed to setRemoteDescription, ",e)});break;case"CANDIDATE":console.log(n.candidate);var o=new RTCIceCandidate(n.candidate);e._pc.addIceCandidate(o);break;case"DEFAULT":console.log("ORIGINATOR: message not recognized ",n.type)}}),window.onbeforeunload=function(){!e._pc||e._pc.close(),!!e._socket&&!!e._peer&&(e._socket.send(JSON.stringify({type:"LEAVE",dst:e._peer})),!e._dc||e._dc.close())}},f.prototype.setupIce=function(){var e=this;this._pc.onicecandidate=function(t){console.log("candidates received"),t.candidate?e._socket.send(JSON.stringify({type:"CANDIDATE",candidate:t.candidate,dst:e._peer})):console.log("End of candidates.")}},f.prototype.startPeerConnection=function(){this._pc=new t(this._config,{optional:[{RtpDataChannels:!0}]}),this.setupIce(),this.setupAudioVideo()},f.prototype.maybeBrowserisms=function(e){var t=this;i=="Firefox"&&!this._video&&!this._audio&&!this._stream?n({audio:!0,fake:!0},function(n){t._pc.addStream(n),e?t.makeOffer():t.makeAnswer()},function(e){console.log("crap")}):e?this.makeOffer():this.makeAnswer()},f.prototype.makeAnswer=function(){var e=this;this._pc.createAnswer(function(t){console.log("createAnswer"),e._pc.setLocalDescription(t,function(){console.log("setLocalDescription: answer"),e._socket.send(JSON.stringify({type:"ANSWER",src:e._id,sdp:t,dst:e._peer}))},function(e){console.log("failed to setLocalDescription, ",e)})},function(e){console.log("failed to create answer, ",e)})},f.prototype.makeOffer=function(){var e=this;this._pc.createOffer(function(t){console.log("createOffer"),e._pc.setLocalDescription(t,function(){console.log("setLocalDescription: offer"),e._socket.send(JSON.stringify({type:"OFFER",sdp:t,dst:e._peer,src:e._id}))},function(e){console.log("failed to setLocalDescription, ",e)})})},f.prototype.setupAudioVideo=function(){var e=this;console.log("onaddstream handler added"),this._pc.onaddstream=function(t){console.log("Remote stream added"),this._stream=!0,!e._handlers.remotestream||e._handlers.remotestream(t.type,t.stream)}},f.prototype.handleStream=function(e,t){this._data&&this.setupDataChannel(e),this.getAudioVideo(e,t)},f.prototype.getAudioVideo=function(e,t){var r=this;this._video?n({video:!0},function(e){r._pc.addStream(e),console.log("Local video stream added"),!r._handlers.localstream||r._handlers.localstream("video",e),r._audio?n({audio:!0},function(e){r._pc.addStream(e),console.log("Local audio stream added"),!r._handlers.localstream||r._handlers.localstream("audio",e),t()},function(e){console.log("Audio cannot start"),t()}):t()},function(e){console.log("Video cannot start",e),t()}):this._audio?n({audio:!0},function(e){r._pc.addStream(e),!r._handlers.localstream||r._handlers.localstream("audio",e),t()},function(e){console.log("Audio cannot start"),t()}):t()},f.prototype.setupDataChannel=function(e,t){var n=this;e?i=="Webkit"?this._pc.onstatechange=function(){console.log("State Change: ",n._pc.readyState)}:this._pc.onconnection=function(){console.log("ORIGINATOR: onconnection triggered"),n.startDataChannel()}:(this._pc.ondatachannel=function(e){console.log("SINK: ondatachannel triggered"),n._dc=e,n._dc.binaryType="blob",!n._handlers.connection||n._handlers.connection(n._peer),n._dc.onmessage=function(e){n.handleDataMessage(e)}},this._pc.onconnection=function(){console.log("SINK: onconnection triggered")}),this._pc.onclosedconnection=function(){}},f.prototype.startDataChannel=function(){var e=this;this._dc=this._pc.createDataChannel(this._peer,{reliable:!1}),this._dc.binaryType="blob",!this._handlers.connection||this._handlers.connection(this._peer),this._dc.onmessage=function(t){e.handleDataMessage(t)}},f.prototype.send=function(e){var t=BinaryPack.pack(e);this._dc.send(t)},f.prototype.handleDataMessage=function(e){var t=this,n=new FileReader;n.onload=function(e){var n=e.target.result,r=BinaryPack.unpack(n);!t._handlers.data||t._handlers.data(r)},n.readAsArrayBuffer(e.data)},f.prototype.on=function(e,t){this._handlers[e]=t},e.Peer=f})(this)